<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard Runner (Electron - Sprint2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        #err {
            position: fixed;
            inset: 0;
            background: #111e;
            color: #fff;
            padding: 16px;
            white-space: pre-wrap;
            font-family: ui-monospace,Consolas,monospace;
            display: none;
            z-index: 99999;
        }
    </style>
    <script>
        function showErr(title, msg) {
            let el = document.getElementById('err');
            if (!el) { el = document.createElement('pre'); el.id = 'err'; document.body.appendChild(el); }
            el.style.display = 'block';
            el.textContent = `[${title}]\n` + msg;
        }
        window.addEventListener('error', e => showErr('Runtime Error', (e && (e.message || e.error)) || 'Unknown'));
        window.addEventListener('unhandledrejection', e => showErr('Unhandled Rejection', (e.reason && (e.reason.stack || e.reason.message)) || String(e.reason)));
        console.log('[probe] index.html loaded');
    </script>
</head>
<body class="bg-slate-50">
    <div id="root" class="min-h-screen"></div>
    <script type="text/babel" data-presets="env,react" data-plugins="proposal-class-properties,proposal-nullish-coalescing-operator,proposal-optional-chaining">

const Trophy = (p)=> <span {...p}>ğŸ†</span>;
const Coins = (p)=> <span {...p}>ğŸª™</span>;
const Sword = (p)=> <span {...p}>ğŸ—¡ï¸</span>;
const Dice6 = (p)=> <span {...p}>ğŸ²</span>;
const ShoppingCart = (p)=> <span {...p}>ğŸ›’</span>;
const Waves = (p)=> <span {...p}>ğŸŒŠ</span>;
const Plus = (p)=> <span {...p}>ï¼‹</span>;
const Settings2 = (p)=> <span {...p}>âš™ï¸</span>;
const ClipboardList = (p)=> <span {...p}>ğŸ“‹</span>;

const { useState, useEffect, useMemo, useRef } = React;

// ---- Config ----
const CFG = {
  statPointsPerLevel: 5,
  xpDaily: { ex: 40, study: 30, sleep: 20 },
  xpWeekly: { STR: 120, DEX: 140, VIT: 140, INT: 120, ARC: 120, WIL: 240 },
};

// â–¶ Feature Flags (FF)
// - HIDE_LEGEND_AURA: ì „ì„¤ ì˜¤ë¼ UI/íš¨ê³¼ ìˆ¨ê¹€
// - HIDE_TOWN_FACILITIES: ë§ˆì„ ì‹œì„¤ UI ìˆ¨ê¹€
// - SETITEM_SYSTEM: ì„¸íŠ¸ì•„ì´í…œ ê³„ì‚°/íˆ´íŒ í™œì„±í™”
// - ADVANCED_TOOLTIP: ê³ ê¸‰ íˆ´íŒ(í…Œë§ˆ ë“± ì¶”ê°€ ì •ë³´)
// - EQUIP_GUARDS: ì¥ì°© ê°€ë“œ(ì•ˆë‚´/ì œì•½) í™œì„±í™”
const FF = {
  HIDE_LEGEND_AURA: true,
  HIDE_TOWN_FACILITIES: true,
  SETITEM_SYSTEM: true,
  ADVANCED_TOOLTIP: true,
  EQUIP_GUARDS: true,
};

// ---- Helpers ----
function clamp(n, lo, hi) { return Math.max(lo, Math.min(hi, n)); }
function randBetween(a, b) { return a + Math.random() * (b - a); }

// Weighted draw with LUK bias (for tiers)
function drawTierWithLuck(luk, extraBias = 0) {
  const baseBias = Math.min(0.02 * luk, 0.5);
  const bias = Math.min(baseBias + extraBias, 0.5);
  const base = { Common: 100, Uncommon: 45, Rare: 12, Epic: 3, Legend: 1 };
  const scaled = {
    Common: base.Common * (1 - 0.6 * bias),
    Uncommon: base.Uncommon * (1 - 0.3 * bias),
    Rare: base.Rare * (1 + 0.4 * bias),
    Epic: base.Epic * (1 + 0.8 * bias),
    Legend: base.Legend * (1 + 1.2 * bias),
  };
  const sum = Object.values(scaled).reduce((a, b) => a + b, 0);
  let r = Math.random() * sum;
  for (const [k, v] of Object.entries(scaled)) { if (r < v) return k; r -= v; }
  return "Common";
}

// â”€â”€ ì•„ì´í…œ í’€ (ë¬´ê¸°/ë°©íŒ¨/ë°©ì–´êµ¬/ì¥ì‹ êµ¬ í¬í•¨) â”€â”€
const ITEM_POOL = {
  Common: [
    "ì´ˆê¸‰ í•œì†ê²€", "ë‚¡ì€ ì¥ê°‘", "ì²œ ìƒì˜", "ì²œ í•˜ì˜", "ê°€ì£½ ì¥í™”",
    "êµ¬ë¦¬ ë°˜ì§€", "ì€ ê·€ê±¸ì´", "ê°€ì£½ ëª©ê±¸ì´", "ëª©ì¬ ë°©íŒ¨",
    "í•˜ê¸‰ íšŒë³µì•½", "ê¸°ë³¸ ì¬ë£Œ ë¬¶ìŒ"
  ],
  Uncommon: [
    "í›ˆë ¨ìš© ê³¡ê²€(ì–‘ì†)", "ê°€ì£½ ë‘ê±´", "ê°€ì£½ íŒ”ë³´í˜¸êµ¬", "ê²¬ê³ í•œ ë²¨íŠ¸",
    "ì •ì œ ì¬ë£Œ", "ê¸°ë¯¼ì˜ ë¹„ì•½"
  ],
  Rare: [
    "ì˜¤í¬ ëŒ€ê²€(ì–‘ì†)", "ê°•ì²  í‰ê°‘", "ê°•ì²  ê°ë°˜", "ê°•ì²  ë°©íŒ¨",
    "ë§ˆë ¥ì˜ ë¬¸ì¥", "ì•½ì  ì‹ë³„ ë Œì¦ˆ", "í¬ê·€ ì¬ë£Œ"
  ],
  Epic: ["ì˜ì›…ì˜ ì¥ê²€", "ë¶ˆêµ´ì˜ ê²¬ê°‘", "ì‹¬ì—°ì˜ ì„œì•½", "ê¸°ì‚¬ì˜ ë°©íŒ¨", "ë§¹ë… ê·¸ë¦¼ìë‹¨ê²€", "ì „ì„¤ì˜ ì¡°ê°(íŒŒí¸)"],
  Legend: ["ì™•ì˜ ì¸ì¥", "ìš´ëª…ì˜ ë™ì „", "ì‹œê°„ì˜ ëª¨ë˜", "ìˆ˜í˜¸ì˜ ë°©íŒ¨"]
};

// ì„¸íŠ¸ ë³´ë„ˆìŠ¤ ì •ì˜
const SET_BONUSES = {
  Knight: {
    name: 'ê¸°ì‚¬ë‹¨ ì„¸íŠ¸',
    pieces: {2: [{k:'def_pct',v:10},{k:'block_pct',v:10}], 3:[{k:'atk_pct',v:10},{k:'wp_flat',v:5}]}
  },
  Arcane: {
    name: 'ë¹„ì „ ì„¸íŠ¸',
    pieces: {2: [{k:'crit_chance_pct',v:5},{k:'mpregen_pct',v:10}], 3:[{k:'exp_gain_pct',v:10},{k:'atk_pct',v:5}]}
  },
  Vanguard: {
    name: 'ì „ìœ„ ì„¸íŠ¸',
    pieces: {2: [{k:'hp_pct',v:10},{k:'def_pct',v:10}], 3:[{k:'block_pct',v:10},{k:'thorns',v:5}]}
  }
};

// ---- í…Œë§ˆ ê¸°ë°˜ íŠ¹ìˆ˜íš¨ê³¼ í’€ ----
const THEME_POOLS = {
  // generic by slot
  weapon: [
    {k:'atk_pct',min:6,max:12}, {k:'crit_chance_pct',min:3,max:8}, {k:'lifesteal_pct',min:1,max:3}
  ],
  shield: [
    {k:'def_pct',min:6,max:12}, {k:'block_pct',min:8,max:15}, {k:'thorns',min:4,max:10}
  ],
  armor: [
    {k:'def_pct',min:6,max:12}, {k:'hp_pct',min:6,max:12}, {k:'thorns',min:3,max:8}
  ],
  accessory: [
    {k:'crit_chance_pct',min:3,max:8}, {k:'mpregen_pct',min:8,max:15}, {k:'exp_gain_pct',min:6,max:12}, {k:'silver_gain_pct',min:6,max:12}
  ],
  // themed
  knight_off: [
    {k:'atk_pct',min:7,max:12}, {k:'def_pct',min:5,max:10}
  ],
  knight_def: [
    {k:'def_pct',min:8,max:14}, {k:'block_pct',min:6,max:12}
  ],
  guardian: [
    {k:'block_pct',min:10,max:18}, {k:'def_pct',min:6,max:12}, {k:'thorns',min:4,max:10}
  ],
  vanguard_def: [
    {k:'hp_pct',min:8,max:14}, {k:'def_pct',min:6,max:12}
  ],
  assassin: [
    {k:'crit_chance_pct',min:5,max:10}, {k:'atk_pct',min:6,max:12}, {k:'lifesteal_pct',min:1,max:3}
  ],
  berserker: [
    {k:'atk_pct',min:8,max:14}, {k:'crit_chance_pct',min:4,max:9}
  ],
  arcane: [
    {k:'mpregen_pct',min:10,max:18}, {k:'exp_gain_pct',min:6,max:12}, {k:'atk_pct',min:4,max:9}
  ],
  luck: [
    {k:'crit_chance_pct',min:5,max:10}, {k:'silver_gain_pct',min:10,max:18}, {k:'exp_gain_pct',min:6,max:12}
  ]
};

const THEMES = {
  // ë¬´ê¸°
  'ì˜ì›…ì˜ ì¥ê²€': 'knight_off',
  'ì˜¤í¬ ëŒ€ê²€(ì–‘ì†)': 'berserker',
  'ë§¹ë… ê·¸ë¦¼ìë‹¨ê²€': 'assassin',
  // ë°©íŒ¨/ë°©ì–´êµ¬
  'ê¸°ì‚¬ì˜ ë°©íŒ¨': 'guardian',
  'ê°•ì²  ë°©íŒ¨': 'vanguard_def',
  'ê°•ì²  í‰ê°‘': 'knight_def',
  'ê°•ì²  ê°ë°˜': 'vanguard_def',
  'ë¶ˆêµ´ì˜ ê²¬ê°‘': 'vanguard_def',
  // ì¥ì‹ êµ¬
  'ë§ˆë ¥ì˜ ë¬¸ì¥': 'arcane',
  'ì•½ì  ì‹ë³„ ë Œì¦ˆ': 'arcane',
  'ì‹œê°„ì˜ ëª¨ë˜': 'arcane',
  'ìš´ëª…ì˜ ë™ì „': 'luck',
};

// ğŸ”§ ì•„ì´í…œ ì •ì˜(íƒ€ì…/ìŠ¤íƒ¯/ê³µê²©ë ¥/ë°©ì–´ë ¥/ë§‰ê¸°/ì„¸íŠ¸/ê³ ìœ ëŠ¥ë ¥Â·ìŠ¤í‚¬)
// fields: type, mod(ê¸°ë³¸ ìŠ¤íƒ¯), wp(ë¬´ê¸°ê³µ), df(ë°©ì–´ë ¥), block(%), setKey,
//         uniqueAbilities:[{name,desc,when?,chance?,dur?}], uniqueSkill:{name,cooldown,desc}
const ITEM_DEFS = {
  // ë¬´ê¸°
  "ì´ˆê¸‰ í•œì†ê²€": { type: "weapon_1h", wp: 8, mod: { STR: 1 } },
  "ì˜ì›…ì˜ ì¥ê²€": { type: "weapon_1h", wp: 18, mod: { STR: 3, DEX: 1 }, setKey:'Knight',
    uniqueAbilities:[{name:'ìš©ì‚¬ì˜ ì˜ì§€', desc:'ì  ì²˜ì¹˜ ì‹œ 10ì´ˆê°„ ê³µê²©ë ¥ +10% (ì¤‘ì²© 1)', when:'onKill', chance:1, dur:10}] },
  "í›ˆë ¨ìš© ê³¡ê²€(ì–‘ì†)": { type: "weapon_2h", wp: 12, mod: { STR: 2 } },
  "ì˜¤í¬ ëŒ€ê²€(ì–‘ì†)": { type: "weapon_2h", wp: 26, mod: { STR: 4, WIL: 1 },
    uniqueAbilities:[{name:'ì˜¤í¬ì˜ ê´‘ë¶„', desc:'HP 50% ì´í•˜ì—ì„œ ì¹˜ëª…íƒ€ í”¼í•´ +30%', when:'onBelowHP', threshold:0.5}] },
  // ì—í”½: ë§¹ë… ê·¸ë¦¼ìë‹¨ê²€(êµ¬ ë…ë‹¨ê²€)
  "ë§¹ë… ê·¸ë¦¼ìë‹¨ê²€": { type: "weapon_1h", wp: 16, mod:{ DEX:2 },
    uniqueAbilities:[
      {name:'ë§¹ë…ì˜ ë² ê¸°', desc:'ì ì¤‘ ì‹œ 20% í™•ë¥ ë¡œ 3ì´ˆê°„ ì¶œí˜ˆ', when:'onHit', chance:0.20, dur:3},
      {name:'ë§ˆë¹„ ë…', desc:'ì ì¤‘ ì‹œ 8% í™•ë¥ ë¡œ 1ì´ˆê°„ ë§ˆë¹„', when:'onHit', chance:0.08, dur:1}
    ] },

  // ë°©íŒ¨(ë¬´ê¸° ìŠ¬ë¡¯)
  "ëª©ì¬ ë°©íŒ¨": { type: "shield", df: 3, block: 8, mod: { VIT: 1 } },
  "ê°•ì²  ë°©íŒ¨": { type: "shield", df: 7, block: 15, mod: { VIT: 2, WIL: 1 }, setKey:'Vanguard',
    uniqueAbilities:[{name:'íŠ¼íŠ¼í•œ ë°©ì–´', desc:'ë§‰ê¸° ì„±ê³µ ì‹œ ë‹¤ìŒ í”¼ê²© í”¼í•´ -10%', when:'onBlock', chance:1, dur:5}] },
  "ê¸°ì‚¬ì˜ ë°©íŒ¨": { type: "shield", df: 9, block: 18, mod: { VIT: 3 }, setKey:'Knight',
    uniqueAbilities:[{name:'ê²¬ê³ í•œ ìì„¸', desc:'ë§‰ê¸° ì‹œ 5ì´ˆê°„ ë°©ì–´ë ¥ +15%', when:'onBlock', chance:1, dur:5}] },
  // ì „ì„¤ ë°©íŒ¨(ìŠ¤í‚¬ ë³´ìœ )
  "ìˆ˜í˜¸ì˜ ë°©íŒ¨": { type: "shield", df: 14, block: 25, mod:{ VIT:3, WIL:2 }, setKey:'Knight',
    uniqueAbilities:[{name:'ìˆ˜í˜¸ì', desc:'ìì‹  ë’¤ì˜ ì•„êµ° ë§‰ê¸° +10% (ìƒì‹œ)'}],
    uniqueSkill:{ name:'ìˆ˜í˜¸ì˜ ê²°ê³„', cooldown:'60s', desc:'6ì´ˆ ë™ì•ˆ ê²°ê³„ ë‚´ ì•„êµ° ë°©ì–´ë ¥ +30%, ë°›ëŠ” í”¼í•´ 30%ë¥¼ ìì‹ ì´ ëŒ€ì‹  ë°›ìŒ' }
  },

  // ë°©ì–´êµ¬ (df ì¤‘ì‹¬)
  "ê°€ì£½ ë‘ê±´": { type: "armor_head", df: 2, mod: { WIL: 1 } },
  "ì²œ ìƒì˜": { type: "armor_chest", df: 1, mod: { ARC: 1 } },
  "ê°•ì²  í‰ê°‘": { type: "armor_chest", df: 8, mod: { VIT: 2 }, setKey:'Knight',
    uniqueAbilities:[{name:'ì² ê°‘', desc:'í”¼ê²© ì‹œ 5ì´ˆê°„ ë°›ëŠ” í”¼í•´ -5% (ì¿¨ 10s)', when:'onDamaged', chance:1, dur:5}] },
  "ì²œ í•˜ì˜": { type: "armor_legs", df: 1, mod: { DEX: 1 } },
  "ê°•ì²  ê°ë°˜": { type: "armor_legs", df: 6, mod: { VIT: 2 }, setKey:'Vanguard',
    uniqueAbilities:[{name:'í•˜ì¤‘ ë¶„ì‚°', desc:'ì´ë™ ì¤‘ ë°›ëŠ” í”¼í•´ -10%'}] },
  "ê°€ì£½ íŒ”ë³´í˜¸êµ¬": { type: "armor_arms", df: 2, mod: { DEX: 1 } },
  "ë¶ˆêµ´ì˜ ê²¬ê°‘": { type: "armor_arms", df: 4, mod: { VIT: 2 }, setKey:'Vanguard',
    uniqueAbilities:[{name:'ë¶ˆêµ´', desc:'HP 50% ì´í•˜ ì‹œ ë°©ì–´ë ¥ +20%', when:'onBelowHP', threshold:0.5}] },
  "ê°€ì£½ ì¥í™”": { type: "armor_feet", df: 2, mod: { DEX: 1 } },
  "ë‚¡ì€ ì¥ê°‘": { type: "armor_arms", df: 1, mod: { DEX: 1 } },

  // ì¥ì‹ êµ¬ (ë ˆì „ë”ë¦¬ëŠ” ìŠ¤í‚¬ í¬í•¨)
  "êµ¬ë¦¬ ë°˜ì§€": { type: "ring", mod: { LUK: 1 } },
  "ë§ˆë ¥ì˜ ë¬¸ì¥": { type: "necklace", mod: { ARC: 2 }, setKey:'Arcane',
    uniqueAbilities:[{name:'ë¹„ì „ ì¦í­', desc:'ìŠ¤í‚¬ MP ì†Œëª¨ -10%'}] },
  "ì•½ì  ì‹ë³„ ë Œì¦ˆ": { type: "earring", mod: { INT: 2 }, setKey:'Arcane',
    uniqueAbilities:[{name:'ì•½ì  ë…¸ì¶œ', desc:'ì²« ì ì¤‘ ëŒ€ìƒ 5ì´ˆê°„ ì¹˜ëª…í™•ë¥  +10%', when:'onHit', chance:1, dur:5, once:true}] },
  "ì‹¬ì—°ì˜ ì„œì•½": { type: "ring", mod: { WIL: 2 },
    uniqueAbilities:[{name:'ì‹¬ì—°ì˜ ê³„ì•½', desc:'HP 30% ì´í•˜ ì‹œ ìƒí¡ +3%', when:'onBelowHP', threshold:0.3}] },

  // Legend ì•¡ì„¸ì„œë¦¬ë“¤ â€” ê³ ìœ ëŠ¥ë ¥ + ê³ ìœ ìŠ¤í‚¬
  "ì™•ì˜ ì¸ì¥": { type: "ring", mod: { CHA: 2 },
    uniqueAbilities:[{name:'ëª…ì„±', desc:'ì „íˆ¬ í›„ ì‹¤ë²„ íšë“ +10%'}],
    uniqueSkill:{ name:'ì™•ì˜ ì¹™ë ¹', cooldown:'90s', desc:'8ì´ˆê°„ íŒŒí‹° ê³µê²©ë ¥ +15%'} },
  // âœ… ë™ì „: ëª©ê±¸ì´ -> ë°˜ì§€ ë¡œ ë³€ê²½ (ê°™ì€ ì„¸íŠ¸ ì¥ì°© ì‹œ ì„¸íŠ¸íš¨ê³¼ ê°€ëŠ¥)
  "ìš´ëª…ì˜ ë™ì „": { type: "ring", mod: { LUK: 2 }, setKey:'Arcane',
    uniqueAbilities:[{name:'í–‰ìš´ì˜ í¸í–¥', desc:'ì¹˜ëª…íƒ€ í™•ë¥  +5%'}],
    uniqueSkill:{ name:'ë™ì „ì˜ ì‹¬íŒ', cooldown:'1íšŒ/ì „íˆ¬', desc:'ë“œë ë“±ê¸‰ì„ í•œ ë²ˆ ì¬êµ´ë¦¼'} },
  "ì‹œê°„ì˜ ëª¨ë˜": { type: "earring", mod: { DEX: 2 }, setKey:'Arcane',
    uniqueAbilities:[{name:'ì‹œê°„ íë¦„', desc:'MP ì¬ìƒ +15%'}],
    uniqueSkill:{ name:'ì‹œê°„ ì™œê³¡', cooldown:'120s', desc:'6ì´ˆê°„ ì´ë™/í–‰ë™ ì†ë„ +30%'} },

  // ê¸°íƒ€
  "ì€ ê·€ê±¸ì´": { type: "earring", mod: { CHA: 1 } },
  "ê°€ì£½ ëª©ê±¸ì´": { type: "necklace", mod: { WIL: 1 } },
  "í•˜ê¸‰ íšŒë³µì•½": { type: "consumable", mod: {} },
  "ê¸°ë¯¼ì˜ ë¹„ì•½": { type: "consumable", mod: {} },
  "ê¸°ë³¸ ì¬ë£Œ ë¬¶ìŒ": { type: "material", mod: {} },
  "ì •ì œ ì¬ë£Œ": { type: "material", mod: {} },
  "í¬ê·€ ì¬ë£Œ": { type: "material", mod: {} },
  "ì „ì„¤ì˜ ì¡°ê°(íŒŒí¸)": { type: "material", mod: {} },
};

function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function getItemDef(name){ return ITEM_DEFS[name] || { type: "weapon_1h", wp: 6, mod: { STR: 1 } }; }

function makeNamedItem(name, tier){
  const base = getItemDef(name);
  const item = {
    id: uid(), name, tier, type: base.type,
    mod: { ...(base.mod||{}) }, wp: base.wp||0, df: base.df||0, block: base.block||0,
    effects: [], setKey: base.setKey, theme: THEMES[name],
    uniqueAbilities: base.uniqueAbilities ? JSON.parse(JSON.stringify(base.uniqueAbilities)) : [],
    uniqueSkill: base.uniqueSkill ? { ...base.uniqueSkill } : null,
  };
  // Rare ì´ìƒì€ ëœë¤ íŠ¹ìˆ˜íš¨ê³¼(ê³ ìœ ì™€ ë³„ê°œ)
  item.effects = (tier==='Rare'||tier==='Epic'||tier==='Legend')? rollEffectsFor(item): [];
  return item;
}

// íŠ¹ìˆ˜íš¨ê³¼ ë¡¤ â€” Rare:1 / Epic:2 / Legend:3
function rollEffectsFor(item){
  const tier = item.tier;
  const count = tier==='Rare'?1: tier==='Epic'?2: tier==='Legend'?3: 0;
  if(count<=0) return [];
  // ê¸°ë³¸ í’€ (íƒ€ì…)
  let pool = [];
  if(item.type==='weapon_1h' || item.type==='weapon_2h') pool = THEME_POOLS.weapon;
  else if(item.type==='shield') pool = THEME_POOLS.shield;
  else if(String(item.type).startsWith('armor_')) pool = THEME_POOLS.armor;
  else if(['ring','earring','necklace'].includes(item.type)) pool = THEME_POOLS.accessory;
  // í…Œë§ˆ ìš°ì„ 
  if(item.theme && THEME_POOLS[item.theme]) pool = THEME_POOLS[item.theme];

  const effects=[]; const used=new Set();
  for(let i=0;i<count && i<pool.length;i++){
    let pickIdx=0; let safe=0;
    do{ pickIdx = Math.floor(Math.random()*pool.length); safe++; } while(used.has(pickIdx) && safe<20);
    used.add(pickIdx);
    const e = pool[pickIdx];
    const val = Math.round(randBetween(e.min, e.max));
    effects.push({k:e.k, v:val});
  }
  return effects;
}

function makeItem(tier){
  const name = pick(ITEM_POOL[tier]);
  return makeNamedItem(name, tier);
}

// í•©ì„± ìœ í‹¸
function addStatMods(a={}, b={}){ const out = { ...a }; for(const k of Object.keys(b||{})) out[k] = (out[k]||0) + (b[k]||0); return out; }
function mergeEffects(effectsArr){ const t={}; for(const e of effectsArr){ t[e.k]=(t[e.k]||0)+e.v; } return t; }

// íŒë§¤ê°€(ê°„ë‹¨)
const SELL_PRICE = { Common: 10, Uncommon: 30, Rare: 80, Epic: 200, Legend: 500 };

// íƒ€ì… ë¼ë²¨
function typeLabel(t){
  const map = {
    weapon_1h: 'í•œì† ë¬´ê¸°', weapon_2h: 'ì–‘ì† ë¬´ê¸°', shield: 'ë°©íŒ¨(ë¬´ê¸° ìŠ¬ë¡¯)',
    armor_head: 'ë¨¸ë¦¬', armor_chest: 'ìƒì˜', armor_legs: 'í•˜ì˜', armor_arms: 'íŒ”', armor_feet: 'ë°œ(ì‹ ë°œ)',
    ring: 'ë°˜ì§€', earring: 'ê·€ê±¸ì´', necklace: 'ëª©ê±¸ì´',
    consumable: 'ì†Œë¹„', material: 'ì¬ë£Œ'
  };
  return map[t] || t;
}

class ErrorBoundary extends React.Component { constructor(props){ super(props); this.state={ error:null }; } static getDerivedStateFromError(error){ return { error }; } componentDidCatch(error, info){ console.error('Preview runtime error:', error, info); } render(){ if(this.state.error){ return (<div style={{padding:'12px',border:'1px solid #fca5a5',background:'#fff1f2',borderRadius:12,color:'#b91c1c'}}><div style={{fontWeight:'bold'}}>ë¯¸ë¦¬ë³´ê¸° ëŸ°íƒ€ì„ ì—ëŸ¬</div><div style={{fontSize:12,marginTop:4}}>{String(this.state.error?.message||this.state.error)}</div><div style={{fontSize:11,marginTop:6,color:'#7f1d1d'}}>ì—ëŸ¬ë¥¼ ê³ ì¹˜ë©´ ì¦‰ì‹œ ë¯¸ë¦¬ë³´ê¸° ë³µêµ¬ë©ë‹ˆë‹¤.</div></div>);} return this.props.children; } }

function Dashboard() {
        // [PATCH:DATA] external data helpers + autoload
        function mergeArrayById(targetArr, srcArr){
          try{
            if (!Array.isArray(targetArr) || !Array.isArray(srcArr)) return;
            const index = new Map(targetArr.map((o,i)=>[(o&&('id'in o)?o.id:((o&&'name'in o)?o.name:i)), i]));
            for (const obj of srcArr){
              const key = (obj&&('id'in obj))?obj.id:((obj&&'name'in obj)?obj.name:undefined);
              if (key!=null && index.has(key)){
                const i = index.get(key);
                targetArr[i] = Object.assign({}, targetArr[i]||{}, obj);
              } else {
                targetArr.push(obj);
              }
            }
          }catch(e){ console.warn('mergeArrayById fail', e); }
        }
        function applyDashDataV1(data){
          try{
            if (data.ITEM_DEFS) mergeArrayById(ITEM_DEFS, data.ITEM_DEFS);
            if (data.SET_BONUSES){
              if (Array.isArray(SET_BONUSES)) mergeArrayById(SET_BONUSES, data.SET_BONUSES);
              else if (typeof SET_BONUSES==='object') Object.assign(SET_BONUSES, data.SET_BONUSES);
            }
            if (data.ITEM_POOL) mergeArrayById(ITEM_POOL, data.ITEM_POOL);
            if (data.THEMES) mergeArrayById(THEMES, data.THEMES);
            if (typeof setLog==='function') setLog(l => [`[DATA] imported ${new Date().toLocaleString()}`, ...(l||[])].slice(0,200));
          }catch(e){ console.warn('applyDashDataV1 fail', e); }
        }
        useEffect(()=>{
          try{
            const raw = localStorage.getItem('dashDataV1');
            if (raw){
              const data = JSON.parse(raw);
              applyDashDataV1(data);
            }
          }catch(e){ console.warn('dashDataV1 load fail', e); }
        }, []);

  // --- Core state ---
  const [lvl, setLvl] = useState(7);
  const [xp, setXp] = useState(2200);
  const [unspent, setUnspent] = useState(0);
  const [stats, setStats] = useState({ STR: 10, DEX: 9, VIT: 9, INT: 8, ARC: 8, CHA: 8, WIL: 9, LUK: 7 });
  const [log, setLog] = useState([]);

  // ğŸ”§ Dev: ë¹ ë¥¸ ë¯¸ë¦¬ë³´ê¸°ìš© ìŠ¤ìœ„ì¹˜
  const [devFast, setDevFast] = useState(true);
  const [devMount, setDevMount] = useState({ equipment: true, inventory: true, quests: true, weekly: true, test: true, log: true });

  // ë ˆë²¨/NXP
  const nxp = useMemo(() => nxpForLevel(lvl), [lvl]);
  const curLevelBase = useMemo(()=> totalXpForLevel(lvl-1), [lvl]);
  const nxpLeft = Math.max(nxp - (xp - curLevelBase), 0);
  function nxpForLevel(L){ return Math.round(60 + 20 * L + 8 * L * L); }
  function totalXpForLevel(L) { if (L <= 0) return 0; let s = 0; for (let i = 1; i <= L; i++) s += nxpForLevel(i); return s; }
  function addXp(amount, reason="XP"){ setXp(prev=>{ let newXp=prev+amount; let curLvl=lvl; let unsp=unspent; let base=totalXpForLevel(curLvl-1); let need=nxpForLevel(curLvl); const events=[{type:"xp",detail:{amount,reason}}]; while(newXp-base>=need){curLvl+=1;base=totalXpForLevel(curLvl-1);need=nxpForLevel(curLvl);unsp+=CFG.statPointsPerLevel;events.push({type:"levelup",detail:{lvl:curLvl,points:CFG.statPointsPerLevel}});} if(events.length) setLog(l=>[...events.reverse(),...l]); setLvl(curLvl); setUnspent(unsp); return newXp; }); }

  // --- Daily / Weekly ---
  const [daily, setDaily] = useState({ ex:false, study:false, sleep:false });
  const [dCountWeek, setDCountWeek] = useState(0);
  function submitDaily(){ let gained=0,cnt=0; if(daily.ex){gained+=CFG.xpDaily.ex;cnt++;} if(daily.study){gained+=CFG.xpDaily.study;cnt++;} if(daily.sleep){gained+=CFG.xpDaily.sleep;cnt++;} if(!cnt){ setLog(l=>[{type:"warn",detail:"ì¼ì¼í€˜ ì„ íƒ ì—†ìŒ"},...l]); return;} addXp(gained,`ì¼ì¼í€˜(${cnt}ê°œ)`); setDCountWeek(v=>clamp(v+cnt,0,21)); setDaily({ex:false,study:false,sleep:false}); }

  const [wq, setWq] = useState({ STR_pts:0, DEX_form:0, DEX_wins:0, VIT_recov:0, VIT_weightOK:false, INT_units:0, ARC_read:0, ARC_world:0, WIL_streak:false });
  function computeWeeklyQuestXP(){ const res={awards:[], total:0}; if(wq.STR_pts>=4){res.awards.push(["STR+1 ë‹¬ì„±", CFG.xpWeekly.STR]); res.total+=CFG.xpWeekly.STR;} if((wq.DEX_form+Math.min(wq.DEX_wins,5))>=5){res.awards.push(["DEX+1 ë‹¬ì„±", CFG.xpWeekly.DEX]); res.total+=CFG.xpWeekly.DEX;} const vit=wq.VIT_recov+(wq.VIT_weightOK?2:0); if(vit>=6){res.awards.push(["VIT+1 ë‹¬ì„±", CFG.xpWeekly.VIT]); res.total+=CFG.xpWeekly.VIT;} if(wq.INT_units>=6){res.awards.push(["INT+1 ë‹¬ì„±", CFG.xpWeekly.INT]); res.total+=CFG.xpWeekly.INT;} if((wq.ARC_read+wq.ARC_world)>=5){res.awards.push(["ARC+1 ë‹¬ì„±", CFG.xpWeekly.ARC]); res.total+=CFG.xpWeekly.ARC;} if(wq.WIL_streak){res.awards.push(["WIL+1 ë‹¬ì„±", CFG.xpWeekly.WIL]); res.total+=CFG.xpWeekly.WIL;} return res; }

  function buildWeights(){ let w={ STR:.2, DEX:.2, VIT:.2, INT:.15, ARC:.15, WIL:.05, CHA:.025, LUK:.025 }; const sum=Object.values(w).reduce((a,b)=>a+b,0); for(const k in w) w[k]/=sum; return w; }
  function weightedDistribute(P,K,weights){ const statsPool=Object.keys(weights); const picks=[]; const bag=[...statsPool]; for(let i=0;i<K&&bag.length;i++){ const sum=bag.reduce((a,s)=>a+(weights[s]||0),0); let r=Math.random()*sum; for(let j=0;j<bag.length;j++){ const s=bag[j]; r-=(weights[s]||0); if(r<=0){ picks.push(s); bag.splice(j,1); break; } } } const alloc=[]; for(let i=0;i<P;i++){ const s=picks[Math.floor(Math.random()*picks.length)]||"STR"; const row=alloc.find(a=>a.stat===s); if(row) row.delta+=1; else alloc.push({stat:s,delta:1}); } return {alloc}; }

  function rollWeekly(){ const D=clamp(dCountWeek,0,21); const P_base=D<=8?1:D<=15?2:3; const luckProb=Math.min(0.02*stats.LUK,0.4); const LUK_Bonus=Math.random()<=luckProb?1:0; let P_total=P_base+LUK_Bonus; const wk=computeWeeklyQuestXP(); if(wk.total>0){ let K=1+Math.floor(Math.random()*3); if(Math.random()<=luckProb) K=Math.min(3,K+1); const result=weightedDistribute(P_total,K,buildWeights()); const newStats={...stats}; result.alloc.forEach(({stat,delta})=>{ newStats[stat]=(newStats[stat]||0)+delta; }); setStats(newStats); setLog(l=>[{type:"weekly", detail:{D,P_base,LUK_Bonus,P_total,K,alloc:result.alloc}}, ...l]); addXp(wk.total,`ì£¼ê°„í€˜ ë‹¬ì„±(ì´ ${wk.total}XP)`); wk.awards.forEach(([n,v])=>setLog(l=>[{type:"xp",detail:{amount:v,reason:`ì£¼ê°„í€˜: ${n}`}},...l])); } else { P_total=0; setLog(l=>[{type:'warn', detail:'ì£¼ê°„í€˜ ë¯¸ë‹¬(P ì§€ê¸‰ ì—†ìŒ)'} ,...l]); } setDCountWeek(0); setWq({ STR_pts:0, DEX_form:0, DEX_wins:0, VIT_recov:0, VIT_weightOK:false, INT_units:0, ARC_read:0, ARC_world:0, WIL_streak:false }); }

  // --- ì¸ë²¤í† ë¦¬ & ì¥ë¹„ ìƒíƒœ ---
  const [inv, setInv] = useState([]);
  const [equip, setEquip] = useState({
    weaponR: null, weaponL: null,
    head: null, chest: null, legs: null, arms: null, feet: null,
    ear1: null, ear2: null, necklace: null, ring1: null, ring2: null,
  });

  // ìµœì´ˆ ì§„ì…ì‹œ í…ŒìŠ¤íŠ¸ ì¥ë¹„ ì‹œë“œ
  const [devSeeded, setDevSeeded] = useState(false);
  useEffect(()=>{
    if(devSeeded) return;
    const seeds = [
      makeNamedItem('ë§¹ë… ê·¸ë¦¼ìë‹¨ê²€','Epic'),
      makeNamedItem('ìˆ˜í˜¸ì˜ ë°©íŒ¨','Legend'),
      makeNamedItem('ì˜ì›…ì˜ ì¥ê²€','Epic'),
      makeNamedItem('ê¸°ì‚¬ì˜ ë°©íŒ¨','Epic'),
      makeNamedItem('ê°•ì²  í‰ê°‘','Rare'),
      makeNamedItem('ê°•ì²  ë°©íŒ¨','Rare'),
      makeNamedItem('ë¶ˆêµ´ì˜ ê²¬ê°‘','Epic'),
      makeNamedItem('ê°•ì²  ê°ë°˜','Rare'),
      makeNamedItem('ë§ˆë ¥ì˜ ë¬¸ì¥','Rare'),
      makeNamedItem('ìš´ëª…ì˜ ë™ì „','Legend'),
    ];
    setInv(cur=>[...seeds, ...cur]);
    setDevSeeded(true);
  }, [devSeeded]);

  function addItemToInv(item){ setInv(arr=>[item, ...arr]); }
  function removeFromInv(id){ setInv(arr=>arr.filter(x=>x.id!==id)); }

  function isTwoHandEquipped(){ return equip.weaponR && equip.weaponL && (equip.weaponR.id === equip.weaponL.id) && equip.weaponR.type==='weapon_2h'; }

  function equipItem(id){
    const it = inv.find(x=>x.id===id); if(!it) return;
    const t = it.type;
    if(t==='material' || t==='consumable'){ setLog(l=>[{type:'warn', detail:'ì¥ë¹„ ë¶ˆê°€ ì•„ì´í…œì…ë‹ˆë‹¤'}, ...l]); return; }

    if(t==='weapon_2h' || t==='weapon_1h' || t==='shield'){
      if(isTwoHandEquipped()){
        const two = equip.weaponR; setEquip(e=>({ ...e, weaponR: null, weaponL: null })); addItemToInv(two);
      }
      if(t==='weapon_2h'){
        if(equip.weaponR && !(equip.weaponL && equip.weaponR.id===equip.weaponL.id && equip.weaponR.type==='weapon_2h')) addItemToInv(equip.weaponR);
        if(equip.weaponL && !(equip.weaponR && equip.weaponR.id===equip.weaponL.id && equip.weaponL.type==='weapon_2h')) addItemToInv(equip.weaponL);
        setEquip(e=>({ ...e, weaponR: it, weaponL: it }));
        removeFromInv(id);
        setLog(l=>[{ type:'equip', detail:{ slot: 'ì–‘ì†', name: it.name, tier: it.tier } }, ...l]);
        return;
      } else {
        if(!equip.weaponR){ setEquip(e=>({ ...e, weaponR: it })); }
        else if(!equip.weaponL){ setEquip(e=>({ ...e, weaponL: it })); }
        else { addItemToInv(equip.weaponR); setEquip(e=>({ ...e, weaponR: it })); }
        removeFromInv(id);
        setLog(l=>[{ type:'equip', detail:{ slot: !equip.weaponR? 'ì˜¤ë¥¸ì†':'ì™¼ì†', name: it.name, tier: it.tier } }, ...l]);
        return;
      }
    }

    const map = {
      armor_head: 'head', armor_chest: 'chest', armor_legs: 'legs', armor_arms: 'arms', armor_feet: 'feet',
      necklace: 'necklace', ring: ['ring1','ring2'], earring: ['ear1','ear2']
    };
    const slotKey = map[t];
    if(!slotKey){ setLog(l=>[{type:'warn', detail:`ì•Œ ìˆ˜ ì—†ëŠ” íƒ€ì…: ${t}`}, ...l]); return; }

    const put = (slot)=>{ const prev = equip[slot]; setEquip(e=>({ ...e, [slot]: it })); removeFromInv(id); if(prev) addItemToInv(prev); setLog(l=>[{ type:'equip', detail:{ slot, name: it.name, tier: it.tier } }, ...l]); };

    if(Array.isArray(slotKey)){
      if(!equip[slotKey[0]]) put(slotKey[0]);
      else if(!equip[slotKey[1]]) put(slotKey[1]);
      else put(slotKey[0]);
    } else { put(slotKey); }
  }

  function unequip(slot){
    if((slot==='weaponR' || slot==='weaponL') && isTwoHandEquipped()){
      const cur = equip.weaponR; if(!cur) return; setEquip(e=>({ ...e, weaponR: null, weaponL: null })); addItemToInv(cur); setLog(l=>[{type:'unequip', detail:{slot:'ì–‘ì†', name:cur.name}}, ...l]); return;
    }
    const cur = equip[slot]; if(!cur) return; setEquip(e=>({ ...e, [slot]: null })); addItemToInv(cur); setLog(l=>[{type:'unequip', detail:{slot, name: cur.name}}, ...l]);
  }

  function sellItem(id){ const it = inv.find(x=>x.id===id); if(!it) return; const gain = SELL_PRICE[it.tier] || 5; setSilver(s=>s+gain); removeFromInv(id); setLog(l=>[{ type:'shop', detail:{ buy:`íŒë§¤: ${it.name}`, cost:`+${gain}S` } }, ...l]); }

  // ì„¸íŠ¸ ì¹´ìš´íŠ¸
  function countSetEquipped(key){
    const slots = ['weaponR','weaponL','head','chest','legs','arms','feet','ear1','ear2','necklace','ring1','ring2'];
    const seenTwoHand = isTwoHandEquipped();
    const ids = new Set();
    let c=0; for(const s of slots){ const it=equip[s]; if(!it) continue; if(seenTwoHand && s==='weaponL') continue; if(ids.has(it.id)) continue; ids.add(it.id); if(it.setKey===key) c++; }
    return c;
  }

  // ì´ ì¥ë¹„ ë³´ì •ì¹˜ & ì „íˆ¬ìˆ˜ì¹˜ í•©ì‚°
  const gear = useMemo(()=>{
    let stat = {};
    let wp = 0, df = 0, block = 0;
    let effects = [];
    let sets = {};
    let abilities = [];
    let skills = [];
    const slots = ['weaponR','weaponL','head','chest','legs','arms','feet','ear1','ear2','necklace','ring1','ring2'];
    const seenTwoHand = isTwoHandEquipped();
    for(const s of slots){
      const it = equip[s]; if(!it) continue;
      if(seenTwoHand && (s==='weaponL')) continue; // ì–‘ì† ì¤‘ë³µ ë°©ì§€
      stat = addStatMods(stat, it.mod||{});
      wp += it.wp||0; df += it.df||0; block += it.block||0;
      if(it.effects?.length) effects = effects.concat(it.effects);
      if(it.setKey){ sets[it.setKey] = (sets[it.setKey]||0) + 1; }
      if(it.uniqueAbilities?.length) abilities = abilities.concat(it.uniqueAbilities.map(a=>({from:it.name, ...a})));
      if(it.uniqueSkill) skills.push({from:it.name, ...it.uniqueSkill});
    }
    // ì„¸íŠ¸ íš¨ê³¼ ì ìš©
    let setEffects = [];
    const activeSets = [];
    if (FF.SETITEM_SYSTEM) {
      for (const [key,cnt] of Object.entries(sets)){
        const def = SET_BONUSES[key]; if(!def) continue;
        let totalApplied = 0; const pieces = def.pieces;
        const levels = Object.keys(pieces).map(n=>parseInt(n)).sort((a,b)=>a-b);
        for(const n of levels){ if(cnt>=n){ setEffects = setEffects.concat(pieces[n]); totalApplied = n; } }
        if(totalApplied>0) activeSets.push({ key, name:def.name, count:cnt, applied: totalApplied });
      }
    }
    const effTotals = mergeEffects(effects.concat(setEffects));
    return { stat, wp, df, block, effTotals, activeSets, abilities, skills };
  }, [equip]);

  // ì¥ë¹„ í¬í•¨ ì‹¤íš¨ ìŠ¤íƒ¯
  const effStats = useMemo(()=>{ const out={...stats}; for(const k of Object.keys(gear.stat)) out[k]=(out[k]||0)+gear.stat[k]; return out; }, [stats, gear]);

  // --- ê²½ì œ/ì „íˆ¬/ì›¨ì´ë¸Œ/ê°€ì±  ---
  const [silver, setSilver] = useState(1180);
  function pullGacha(){ const cost=100; if(silver<cost){ setLog(l=>[{type:'warn', detail:'S ë¶€ì¡±'}, ...l]); return; } const tier=drawTierWithLuck(stats.LUK, 0); const item=makeItem(tier); setSilver(s=>s-cost); addItemToInv(item); setLog(l=>[{type:'gacha', detail:{tier, item: `${item.name}(${typeLabel(item.type)})`, cost}}, ...l]); }
  function earnSilver(kind="normal"){ const luk=stats.LUK; const bias=Math.min(0.02*luk,0.5); let base=0; if(kind==="normal") base=randBetween(4,8); if(kind==="elite") base=randBetween(10,20); if(kind==="boss") base=randBetween(30,80); const gain=Math.round(base*(1+0.5*bias)); setSilver(s=>s+gain); setLog(l=>[{type:'loot', detail:{kind,gain,bias:+bias.toFixed(2)}}, ...l]); }
  function simulateWave(diff="Normal"){ const ranges={Normal:[60,120], Hard:[120,180], Epic:[180,250]}; const r=ranges[diff]||ranges.Normal; const base=randBetween(r[0],r[1]); const bias=Math.min(0.02*stats.LUK,0.5); const gain=Math.round(base*(1+0.5*bias)); setSilver(s=>s+gain); setLog(l=>[{type:'wave', detail:{diff,gain,bias:+bias.toFixed(2)}}, ...l]); }

  function monthlyGoalXPFromLevel(L){ return clamp(Math.round(1.5 * nxpForLevel(L)), 1500, 3000); }
  function submitMonthly(){ const xpAuto = monthlyGoalXPFromLevel(lvl); addXp(xpAuto, `ì›”ê°„í€˜(ì´ë‹¬ì˜ ëª©í‘œ, L=${lvl} â†’ +${xpAuto}XP)`); }

  const g = Math.floor(silver / 100), sRem = silver % 100;
  const dv = useMemo(()=>derive(effStats, gear), [effStats, gear]);
  function derive(s, gear){
    const { STR, DEX, VIT, INT, ARC, WIL } = s;
    const ef = gear.effTotals || {};
    let ATK = Math.round(10 + 2*STR);
    let SPD = Math.round(100 + 3*DEX);
    let HP = Math.round(100 + 10*VIT);
    let STAM = Math.round(50 + 5*VIT);
    let MP = Math.round(60 + 8*ARC);
    let MPRegen = +(1 + 0.1*ARC).toFixed(1);
    let CritChance = +(5 + 0.5*WIL).toFixed(1);
    let CritDamage = +(150 + 2*WIL).toFixed(0);
    let CCResist = +(0 + 0.5*WIL).toFixed(1);
    let GearATK = gear.wp||0;
    let GearDEF = gear.df||0;
    let GearBLOCK = gear.block||0;
    ATK = Math.round((ATK + GearATK) * (1 + (ef.atk_pct||0)/100));
    HP = Math.round(HP * (1 + (ef.hp_pct||0)/100));
    GearDEF = Math.round(GearDEF * (1 + (ef.def_pct||0)/100));
    CritChance = +(CritChance + (ef.crit_chance_pct||0)).toFixed(1);
    CCResist = +(CCResist + (ef.resist_cc_pct||0)).toFixed(1);
    MPRegen = +(MPRegen * (1 + (ef.mpregen_pct||0)/100)).toFixed(1);
    const BlockChance = Math.min(75, +(GearBLOCK + (ef.block_pct||0)).toFixed(1));
    const Thorns = ef.thorns||0;
    const WpFlat = ef.wp_flat||0; ATK += WpFlat;
    return { ATK, SPD, HP, STAM, MP, MPRegen, CritChance, CritDamage, CCResist, DEF: GearDEF, BLOCK: BlockChance, THORNS: Thorns };
  }

  function alloc(stat, delta){ if (delta>0 && unspent<=0) return; setStats(s=>({ ...s, [stat]: Math.max(1, (s[stat]||0) + delta) })); if (delta>0) setUnspent(p=>p-1); }

  // ---- íˆ´íŒ ìƒíƒœ ----
  const [hovered, setHovered] = useState(null); // ì¸ë²¤ ì•„ì´í…œ id
  const [hoveredEquip, setHoveredEquip] = useState(null); // ì¥ë¹„ ìŠ¬ë¡¯ key

  function effectToLabel(k, v){
    const map = { atk_pct:'ê³µê²©ë ¥ +', def_pct:'ë°©ì–´ë ¥ +', crit_chance_pct:'ì¹˜ëª… í™•ë¥  +', hp_pct:'HP +', resist_cc_pct:'ì œì–´ì €í•­ +', exp_gain_pct:'XP íšë“ +', silver_gain_pct:'ì‹¤ë²„ íšë“ +', lifesteal_pct:'ìƒëª…ë ¥ í¡ìˆ˜ +', block_pct:'ë§‰ê¸° +', thorns:'ê°€ì‹œ í”¼í•´ +', mpregen_pct:'MP ì¬ìƒ +', wp_flat:'ë¬´ê¸°ê³µê²©ë ¥ +' };
    const suffix = (k==='thorns'||k==='wp_flat')? '': '%';
    return `${map[k]||k}${v}${suffix}`;
  }

  // ---- ê³ ìœ íš¨ê³¼ í…ŒìŠ¤íŠ¸ í•˜ë„¤ìŠ¤ ----
  function collectAbilities(){
    const list = gear.abilities || [];
    return list.map(a=>({from:a.from, name:a.name, desc:a.desc, when:a.when, chance:a.chance, dur:a.dur, threshold:a.threshold, once:a.once}));
  }

  function testHits(n=30){
    const abs = collectAbilities().filter(a=>a.when==='onHit');
    if(!abs.length){ setLog(l=>[{type:'proc', detail:`ê¸°ë³¸ê³µê²© ${n}íšŒ â†’ ë°œë™ ê°€ëŠ¥í•œ onHit ëŠ¥ë ¥ì´ ì—†ìŒ`}, ...l]); return; }
    const summary = {};
    for(let i=0;i<n;i++){
      for(const a of abs){
        const p = a.chance||0; if(Math.random() < p){
          const key = `${a.name}ã€ˆ${a.from}ã€‰`;
          summary[key] = (summary[key]||0) + 1;
        }
      }
    }
    const msg = Object.keys(summary).length? Object.entries(summary).map(([k,v])=>`${k} x${v}`).join(' Â· ') : 'ë°œë™ ì—†ìŒ';
    setLog(l=>[{type:'proc', detail:`ê¸°ë³¸ê³µê²© ${n}íšŒ í…ŒìŠ¤íŠ¸ â†’ ${msg}`}, ...l]);
  }

  function testDamaged(n=30){
    const onBlock = collectAbilities().filter(a=>a.when==='onBlock');
    const onDamaged = collectAbilities().filter(a=>a.when==='onDamaged');
    const blockRate = (dv.BLOCK||0)/100;
    let b=0, d=0; const sumB={}, sumD={};
    for(let i=0;i<n;i++){
      const blocked = Math.random() < blockRate; if(blocked){ b++; for(const a of onBlock){ if(Math.random() < (a.chance||0)) { const k=`${a.name}ã€ˆ${a.from}ã€‰`; sumB[k]=(sumB[k]||0)+1; } } }
      else { d++; for(const a of onDamaged){ if(Math.random() < (a.chance||0)) { const k=`${a.name}ã€ˆ${a.from}ã€‰`; sumD[k]=(sumD[k]||0)+1; } } }
    }
    const msgB = Object.keys(sumB).length? Object.entries(sumB).map(([k,v])=>`${k} x${v}`).join(' Â· ') : 'â€”';
    const msgD = Object.keys(sumD).length? Object.entries(sumD).map(([k,v])=>`${k} x${v}`).join(' Â· ') : 'â€”';
    setLog(l=>[{type:'proc', detail:`í”¼ê²© ${n}íšŒ(ë§‰ê¸°â‰ˆ${Math.round(blockRate*100)}%) â†’ [ë§‰ê¸° ${b}íšŒ: ${msgB}] [ì§ê²© ${d}íšŒ: ${msgD}]`}, ...l]);
  }

  function testKills(n=5){
    const abs = collectAbilities().filter(a=>a.when==='onKill');
    if(!abs.length){ setLog(l=>[{type:'proc', detail:`ì²˜ì¹˜ ${n}íšŒ â†’ ë°œë™ ê°€ëŠ¥í•œ onKill ëŠ¥ë ¥ì´ ì—†ìŒ`}, ...l]); return; }
    const summary = {};
    for(let i=0;i<n;i++){
      for(const a of abs){ if(Math.random() < (a.chance||0)) { const k=`${a.name}ã€ˆ${a.from}ã€‰`; summary[k]=(summary[k]||0)+1; } }
    }
    const msg = Object.keys(summary).length? Object.entries(summary).map(([k,v])=>`${k} x${v}`).join(' Â· ') : 'ë°œë™ ì—†ìŒ';
    setLog(l=>[{type:'proc', detail:`ì  ì²˜ì¹˜ ${n}íšŒ í…ŒìŠ¤íŠ¸ â†’ ${msg}`}, ...l]);
  }

  function triggerHPBelow(th=0.5){
    const abs = collectAbilities().filter(a=>a.when==='onBelowHP' && (a.threshold||0.5)<=th+1e-9);
    if(!abs.length){ setLog(l=>[{type:'proc', detail:`HP ${Math.round(th*100)}% ì´í•˜ íŠ¸ë¦¬ê±° â†’ ì¡°ê±´ ë§Œì¡± ëŠ¥ë ¥ ì—†ìŒ`}, ...l]); return; }
    const msg = abs.map(a=>`${a.name}ã€ˆ${a.from}ã€‰`).join(' Â· ');
    setLog(l=>[{type:'proc', detail:`HP ${Math.round(th*100)}% ì´í•˜ íŠ¸ë¦¬ê±° â†’ ${msg}`}, ...l]);
  }

  function useUniqueSkill(s){ setLog(l=>[{type:'skill', detail:`ê³ ìœ  ìŠ¤í‚¬ ì‚¬ìš©: ${s.name}ã€ˆ${s.from}ã€‰ â€” ${s.desc} [ì¿¨:${s.cooldown}]`}, ...l]); }

  // â”€â”€ ì„¸íŠ¸ ì •ë³´ ì»´í¬ë„ŒíŠ¸ â”€â”€
  const SetInfo = ({ it, context }) => {
    if(!FF.SETITEM_SYSTEM) return null;
    if(!it?.setKey) return null;
    const def = SET_BONUSES[it.setKey];
    const countNow = countSetEquipped(it.setKey);
    const applied = (gear.activeSets || []).find(s=>s.key===it.setKey)?.applied || 0;
    if(!def) return <div className="mt-1 text-[11px] text-amber-700">ì„¸íŠ¸: {it.setKey}</div>;
    return (
      <div className="mt-1 text-[11px] text-amber-700">
        <div>ì„¸íŠ¸: {def.name} â€” í˜„ì¬ {countNow}ê°œ / í™œì„± {applied}ì„¸íŠ¸</div>
        <div className="mt-1 space-y-0.5 text-amber-800">
          {Object.entries(def.pieces).sort((a,b)=>parseInt(a[0])-parseInt(b[0])).map(([n, list]) => (
            <div key={n}>{n}ì„¸íŠ¸: {list.map(e=>effectToLabel(e.k,e.v)).join(' Â· ')}</div>
          ))}
        </div>
      </div>
    );
  };

  // ---- UI ----
  const logLimit = devFast ? 80 : 200;
  const invList = devFast ? inv.slice(0, 24) : inv;

  return (
    <div className="p-6 grid gap-4 grid-cols-1 lg:grid-cols-3">
      {/* Header */}
      <div className="lg:col-span-3 flex items-center justify-between">
        <h1 className="text-2xl font-bold flex items-center gap-2"><Trophy className="w-6 h-6"/> í˜„ì‹¤ ì—°ë™ RPG ëŒ€ì‹œë³´ë“œ</h1>
        <div className="flex items-center gap-4">
          <div className="flex items-center gap-1"><Coins className="w-5 h-5"/> <span className="font-semibold">{g}G</span> <span className="text-sm text-gray-500">/ {sRem}S</span></div>
          <button className="px-3 py-1 rounded bg-gray-100" onClick={()=>{ setSilver(1180); setStats({ STR: 10, DEX: 9, VIT: 9, INT: 8, ARC: 8, CHA: 8, WIL: 9, LUK: 7}); setUnspent(0); setLog([]); setDCountWeek(0); setWq({STR_pts:0,DEX_form:0,DEX_wins:0,VIT_recov:0,VIT_weightOK:false,INT_units:0,ARC_read:0,ARC_world:0,WIL_streak:false}); setLvl(7); setXp(2200); setInv([]); setEquip({weaponR:null,weaponL:null,head:null,chest:null,legs:null,arms:null,feet:null,ear1:null,ear2:null,necklace:null,ring1:null,ring2:null}); setDevSeeded(false); }}>ë¦¬ì…‹</button>
        </div>
      </div>

      {/* Dev bar */}
      <div className="lg:col-span-3 p-3 border rounded-2xl bg-gray-50 flex items-center justify-between">
        <div className="flex items-center gap-3 text-sm">
          <label className="flex items-center gap-1"><input type="checkbox" checked={devFast} onChange={(e)=>setDevFast(e.target.checked)} /> Fast Dev</label>
          <span className="text-gray-400">|</span>
          <label className="flex items-center gap-1"><input type="checkbox" checked={devMount.equipment} onChange={(e)=>setDevMount(m=>({...m, equipment:e.target.checked}))} /> ì¥ë¹„</label>
          <label className="flex items-center gap-1"><input type="checkbox" checked={devMount.inventory} onChange={(e)=>setDevMount(m=>({...m, inventory:e.target.checked}))} /> ì¸ë²¤</label>
          <label className="flex items-center gap-1"><input type="checkbox" checked={devMount.quests} onChange={(e)=>setDevMount(m=>({...m, quests:e.target.checked}))} /> ì…ë ¥ì°½</label>
          <label className="flex items-center gap-1"><input type="checkbox" checked={devMount.weekly} onChange={(e)=>setDevMount(m=>({...m, weekly:e.target.checked}))} /> ì£¼ê°„</label>
          <label className="flex items-center gap-1"><input type="checkbox" checked={devMount.test} onChange={(e)=>setDevMount(m=>({...m, test:e.target.checked}))} /> í…ŒìŠ¤íŠ¸</label>
          <label className="flex items-center gap-1"><input type="checkbox" checked={devMount.log} onChange={(e)=>setDevMount(m=>({...m, log:e.target.checked}))} /> ë¡œê·¸</label>
        </div>
        <div className="text-xs text-gray-500">Fast Dev: íˆ´íŒ ë¹„í™œì„±/ì¸ë²¤ 24ê°œ ì œí•œ/ë¡œê·¸ 80ê°œ ì œí•œ</div>
      </div>

      {/* Level Card */}
      <div className="p-4 border rounded-2xl shadow-sm bg-white">
        <div className="flex items-center gap-2 mb-2"><Trophy className="w-5 h-5"/><span className="font-semibold">Lv.{lvl}</span></div>
        <div className="text-sm text-gray-600 mb-2">ë‹¤ìŒ ë ˆë²¨ í•„ìš”ì¹˜(NXP): {nxp} â€” ë‚¨ì€ {nxpLeft}</div>
        <div className="w-full h-2 bg-gray-100 rounded"><div className="h-2 bg-gray-800 rounded" style={{ width: `${Math.max(0, Math.min(100, ((xp - curLevelBase) / nxp) * 100))}%` }} /></div>
        <div className="mt-2 text-xs text-gray-500">NXP(L) = 60 + 20L + 8LÂ²</div>
      </div>

      {/* Stats & Status */}
      <div className="p-4 border rounded-2xl shadow-sm bg-white">
        <div className="flex items-center justify-between mb-2">
          <div className="flex items-center gap-2"><Sword className="w-5 h-5"/><span className="font-semibold">ìŠ¤íƒ¯ & ìƒíƒœì°½</span></div>
          <div className="text-sm text-gray-500">ë¯¸ë¶„ë°° í¬ì¸íŠ¸: <b>{unspent}</b></div>
        </div>
        <div className="grid grid-cols-2 gap-2 mb-3">
          {Object.keys(stats).map(k=> (
            <div key={k} className="flex items-center justify-between text-sm">
              <span>{k}: <b>{stats[k]}</b>{gear.stat[k]? <span className="text-xs text-green-600"> (+{gear.stat[k]})</span>: null}</span>
              <div className="flex gap-1"><button className="px-2 border rounded" onClick={()=>alloc(k, +1)} disabled={unspent<=0}><Plus className="w-3 h-3"/></button></div>
            </div>
          ))}
        </div>
        <div className="text-xs text-gray-600 mb-1">íŒŒìƒì¹˜(ì¥ë¹„/íš¨ê³¼/ì„¸íŠ¸ í¬í•¨)</div>
        <div className="grid grid-cols-2 gap-1 text-sm">
          <div>ATK: <b>{dv.ATK}</b></div>
          <div>DEF/ë§‰ê¸°: <b>{dv.DEF}</b> / <b>{dv.BLOCK}%</b></div>
          <div>HP/STM: <b>{dv.HP}</b> / <b>{dv.STAM}</b></div>
          <div>MP/ì¬ìƒ: <b>{dv.MP}</b> / <b>{dv.MPRegen}</b></div>
          <div>ì¹˜ëª…: <b>{dv.CritChance}% / {dv.CritDamage}%</b></div>
          <div>ì €í•­: <b>CC {dv.CCResist}%</b>{dv.THORNS? <span> Â· ê°€ì‹œ {dv.THORNS}</span>: null}</div>
        </div>
        {FF.SETITEM_SYSTEM && gear.activeSets?.length ? (
          <div className="mt-2 text-xs text-indigo-700">í™œì„± ì„¸íŠ¸: {gear.activeSets.map(s=>`${SET_BONUSES[s.key].name} ${s.applied}ì„¸íŠ¸(${s.count}ê°œ ì¥ì°©)`).join(' Â· ')}</div>
        ) : null}
        {gear.abilities?.length ? (
          <div className="mt-2 text-xs text-emerald-700">ê³ ìœ  ëŠ¥ë ¥: {gear.abilities.map(a=>`${a.name}ã€ˆ${a.from}ã€‰`).join(' Â· ')}</div>
        ) : null}
        {gear.skills?.length ? (
          <div className="mt-1 text-xs text-rose-700">ê³ ìœ  ìŠ¤í‚¬: {gear.skills.map(s=>`${s.name}ã€ˆ${s.from}ã€‰[ì¿¨:${s.cooldown}]`).join(' Â· ')}</div>
        ) : null}
      </div>

      {/* ì…ë ¥ì°½ â€” í€˜ìŠ¤íŠ¸ */}
      {devMount.quests && (
      <div className="p-4 border rounded-2xl shadow-sm bg-white">
        <div className="flex items-center gap-2"><Settings2 className="w-5 h-5"/><span className="font-semibold">ì…ë ¥ì°½ â€” í€˜ìŠ¤íŠ¸</span></div>
        <div className="text-sm font-medium mt-1">ì¼ì¼í€˜ìŠ¤íŠ¸</div>
        <label className="text-sm flex items-center gap-2 mt-1"><input type="checkbox" checked={daily.ex} onChange={(e)=>setDaily({...daily, ex:e.target.checked})}/> í—¬ìŠ¤/í™ˆíŠ¸ (+{CFG.xpDaily.ex}XP)</label>
        <label className="text-sm flex items-center gap-2"><input type="checkbox" checked={daily.study} onChange={(e)=>setDaily({...daily, study:e.target.checked})}/> ê³µë¶€/ìˆ˜ì—… (+{CFG.xpDaily.study}XP)</label>
        <label className="text-sm flex items-center gap-2"><input type="checkbox" checked={daily.sleep} onChange={(e)=>setDaily({...daily, sleep:e.target.checked})}/> ìˆ˜ë©´ (+{CFG.xpDaily.sleep}XP)</label>
        <button className="mt-2 px-3 py-2 rounded bg-black text-white" onClick={submitDaily}>ì¼ì¼í€˜ ì™„ë£Œ(ì²´í¬ìˆ˜ë§Œí¼ XP)</button>
        <div className="text-sm font-medium mt-3">ì›”ê°„</div>
        <button className="px-3 py-2 rounded border" onClick={submitMonthly}>ì›”ê°„ í€˜ìŠ¤íŠ¸: ì´ë‹¬ì˜ ëª©í‘œ(ìë™ XP)</button>
      </div>
      )}

      {/* Weekly Controls */}
{ /* [PATCH:UI:DATA-IMPORT] */ true && (
<div className="mt-2 flex items-center gap-2">
          <input id="fileData" type="file" multiple accept=".json,application/json"
            className="text-sm"
            onChange={async e=>{
              const files = Array.from(e.target.files||[]);
              const merged = {};
              for (const f of files){
                const t = await f.text();
                try{
                  const json=JSON.parse(t);
                  ['ITEM_DEFS','SET_BONUSES','ITEM_POOL','THEMES'].forEach(k=>{
                    if (json && json[k]!=null){
                      if (!merged[k]) merged[k] = Array.isArray(json[k]) ? [] : (typeof json[k]==='object'? {}: undefined);
                      if (Array.isArray(json[k])){
                        (merged[k] = merged[k] || []).push(...json[k]);
                      } else if (typeof json[k]==='object'){
                        Object.assign(merged[k], json[k]);
                      }
                    }
                  });
                }catch(err){ alert(`JSON íŒŒì‹± ì‹¤íŒ¨: ${f.name}`); }
              }
              try{
                localStorage.setItem('dashDataV1', JSON.stringify(merged));
              }catch(e){ console.warn('localStorage save fail', e); }
              applyDashDataV1(merged);
              e.target.value = '';
            }} />
          <button className="px-2 py-1 border rounded text-sm" onClick={()=>{
            try{
              const dump = {
                ITEM_DEFS: (typeof ITEM_DEFS?.slice==='function')? ITEM_DEFS.slice(): ITEM_DEFS,
                SET_BONUSES: SET_BONUSES,
                ITEM_POOL: (typeof ITEM_POOL?.slice==='function')? ITEM_POOL.slice(): ITEM_POOL,
                THEMES: (typeof THEMES?.slice==='function')? THEMES.slice(): THEMES,
              };
              const blob = new Blob([JSON.stringify(dump,null,2)], {type:'application/json'});
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url; a.download = 'dashDataV1.json'; a.click(); URL.revokeObjectURL(url);
            }catch(e){ console.warn('export fail', e); }
          }}>ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
          <button className="px-2 py-1 border rounded text-sm" onClick={()=>{
            try{ localStorage.removeItem('dashDataV1'); alert('ì„í¬íŠ¸ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ. ìƒˆë¡œê³ ì¹¨í•˜ë©´ ê¸°ë³¸ ë°ì´í„°ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.'); }
            catch(e){ console.warn('reset fail', e); }
          }}>ì„í¬íŠ¸ ì´ˆê¸°í™”</button>
        </div>
)}
{devMount.weekly && (
      <div className="p-4 border rounded-2xl shadow-sm bg-white flex flex-col gap-3">
        <div className="flex items-center gap-2"><Dice6 className="w-5 h-5"/><span className="font-semibold">ì£¼ê°„ ê²°ì‚° & ì£¼ê°„í€˜</span></div>
        <div className="text-xs text-gray-600">ì¼ì¼í€˜ ì™„ë£Œ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì´ë²ˆ ì£¼ D_countê°€ ëˆ„ì ë©ë‹ˆë‹¤. (ì£¼ê°„ ê²°ì‚° ì‹œ ìë™ ì‚¬ìš©)</div>
        <button className="px-3 py-2 rounded bg-black text-white" onClick={rollWeekly}>ì£¼ê°„ ê²°ì‚° ì‹¤í–‰(P/K ë°°ë¶„ + ì£¼ê°„í€˜ XP)</button>
      </div>
      )}

      {/* Weekly Quest Input */}
      {devMount.weekly && (
      <div className="p-4 border rounded-2xl shadow-sm bg-white flex flex-col gap-2">
        <div className="flex items-center gap-2"><ClipboardList className="w-5 h-5"/><span className="font-semibold">ì£¼ê°„í€˜ ì…ë ¥(ë‹¬ì„±í˜•)</span></div>
        <div className="grid grid-cols-2 gap-2 text-sm">
          <label className="flex items-center justify-between">STR ê·¼ë ¥ì„¸íŠ¸(Ã—1ì )
            <input type="number" min={0} max={20} value={wq.STR_pts} onChange={(e)=>setWq({...wq, STR_pts: clamp(parseInt(e.target.value||0),0,20)})} className="w-20 border rounded px-2 py-1"/>
          </label>
          <label className="flex items-center justify-between">DEX í¼í›ˆë ¨ 10m ë‹¨ìœ„
            <input type="number" min={0} max={20} value={wq.DEX_form} onChange={(e)=>setWq({...wq, DEX_form: clamp(parseInt(e.target.value||0),0,20)})} className="w-20 border rounded px-2 py-1"/>
          </label>
          <label className="flex items-center justify-between">DEX ìŠ¹ë¦¬(ì£¼ 5 ìƒí•œ)
            <input type="number" min={0} max={5} value={wq.DEX_wins} onChange={(e)=>setWq({...wq, DEX_wins: clamp(parseInt(e.target.value||0),0,5)})} className="w-20 border rounded px-2 py-1"/>
          </label>
          <label className="flex items-center justify-between">VIT íšŒë³µ ë£¨í‹´ 10m
            <input type="number" min={0} max={20} value={wq.VIT_recov} onChange={(e)=>setWq({...wq, VIT_recov: clamp(parseInt(e.target.value||0),0,20)})} className="w-20 border rounded px-2 py-1"/>
          </label>
          <label className="flex items-center gap-2"><input type="checkbox" checked={wq.VIT_weightOK} onChange={(e)=>setWq({...wq, VIT_weightOK:e.target.checked})}/> VIT ì²´ì¤‘ +0.1~0.3kg(ì£¼ +2ì )</label>
          <label className="flex items-center justify-between">INT 30m ë‹¨ìœ„
            <input type="number" min={0} max={24} value={wq.INT_units} onChange={(e)=>setWq({...wq, INT_units: clamp(parseInt(e.target.value||0),0,24)})} className="w-20 border rounded px-2 py-1"/>
          </label>
          <label className="flex items-center justify-between">ARC ë…ì„œ 20m
            <input type="number" min={0} max={30} value={wq.ARC_read} onChange={(e)=>setWq({...wq, ARC_read: clamp(parseInt(e.target.value||0),0,30)})} className="w-20 border rounded px-2 py-1"/>
          </label>
          <label className="flex items-center justify-between">ARC ì„¸ê³„ê´€ 200ì
            <input type="number" min={0} max={30} value={wq.ARC_world} onChange={(e)=>setWq({...wq, ARC_world: clamp(parseInt(e.target.value||0),0,30)})} className="w-20 border rounded px-2 py-1"/>
          </label>
          <label className="flex items-center gap-2 col-span-2"><input type="checkbox" checked={wq.WIL_streak} onChange={(e)=>setWq({...wq, WIL_streak:e.target.checked})}/> WIL 7ì¼ ì—°ì† All-Clear ë‹¬ì„±</label>
        </div>
        <div className="text-xs text-gray-600 mt-1">
          {(() => { const p = computeWeeklyQuestXP(); return (
            <div>
              <div>ë¯¸ë¦¬ë³´ê¸°: STR {wq.STR_pts}/4 {wq.STR_pts>=4?"âœ…":"â€”"} Â· DEX {(wq.DEX_form + Math.min(wq.DEX_wins,5))}/5 {(wq.DEX_form + Math.min(wq.DEX_wins,5))>=5?"âœ…":"â€”"} Â· VIT {(wq.VIT_recov + (wq.VIT_weightOK?2:0))}/6 {(wq.VIT_recov + (wq.VIT_weightOK?2:0))>=6?"âœ…":"â€”"} Â· INT {wq.INT_units}/6 {wq.INT_units>=6?"âœ…":"â€”"} Â· ARC {(wq.ARC_read + wq.ARC_world)}/5 {(wq.ARC_read + wq.ARC_world)>=5?"âœ…":"â€”"} Â· WIL {wq.WIL_streak?"âœ…":"â€”"}</div>
              <div>ì´ë²ˆ ì£¼ ì£¼ê°„í€˜ ì˜ˆìƒ XP í•©ê³„: <b>{p.total}</b> XP</div>
            </div>
          ); })()}
        </div>
      </div>
      )}

      {/* ì „íˆ¬/ì›¨ì´ë¸Œ & ìƒì  */}
      <div className="p-4 border rounded-2xl shadow-sm bg-white flex flex-col gap-3">
        <div className="flex items-center gap-2"><Sword className="w-5 h-5"/><span className="font-semibold">ì „íˆ¬/ì›¨ì´ë¸Œ & ìƒì </span></div>
        <div className="flex gap-2">
          <button className="px-3 py-2 rounded bg-gray-900 text-white" onClick={()=>earnSilver("normal")}>ì¼ë°˜ ì „íˆ¬(+S)</button>
          <button className="px-3 py-2 rounded bg-gray-900 text-white" onClick={()=>earnSilver("elite")}>ì •ì˜ˆ ì „íˆ¬(+S)</button>
          <button className="px-3 py-2 rounded bg-gray-900 text-white" onClick={()=>earnSilver("boss")}>ë³´ìŠ¤ ì „íˆ¬(+S)</button>
        </div>
        <div className="flex gap-2">
          <button className="px-3 py-2 rounded border" onClick={pullGacha}><ShoppingCart className="w-4 h-4 inline mr-1"/>ëœë¤ ë½‘ê¸°(100S)</button>
          <button className="px-3 py-2 rounded border" onClick={()=>simulateWave("Normal")}><Waves className="w-4 h-4 inline mr-1"/>ì›¨ì´ë¸Œ: Normal</button>
          <button className="px-3 py-2 rounded border" onClick={()=>simulateWave("Hard")}><Waves className="w-4 h-4 inline mr-1"/>ì›¨ì´ë¸Œ: Hard</button>
          <button className="px-3 py-2 rounded border" onClick={()=>simulateWave("Epic")}><Waves className="w-4 h-4 inline mr-1"/>ì›¨ì´ë¸Œ: Epic</button>
        </div>
      </div>

      {/* ê°€ìƒ ì „íˆ¬ í…ŒìŠ¤íŠ¸(ê³ ìœ ëŠ¥ë ¥/ìŠ¤í‚¬ ë°œë™) */}
      {devMount.test && (
      <div className="p-4 border rounded-2xl shadow-sm bg-white flex flex-col gap-2">
        <div className="font-semibold">ê°€ìƒ ì „íˆ¬ í…ŒìŠ¤íŠ¸</div>
        <div className="text-xs text-gray-600">ì¥ì°© ì¤‘ì¸ ì¥ë¹„ì˜ ê³ ìœ ëŠ¥ë ¥/ìŠ¤í‚¬ ë°œë™ì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤. (í…ŒìŠ¤íŠ¸ ë¡œê·¸ëŠ” ì•„ë˜ ë¡œê·¸ì°½ì— ê¸°ë¡)</div>
        <div className="flex flex-wrap gap-2 mt-1">
          <button className="px-3 py-2 rounded border" onClick={()=>testHits(30)}>ê¸°ë³¸ê³µê²© 30íšŒ</button>
          <button className="px-3 py-2 rounded border" onClick={()=>testDamaged(30)}>í”¼ê²© 30íšŒ(ë§‰ê¸° í¬í•¨)</button>
          <button className="px-3 py-2 rounded border" onClick={()=>testKills(5)}>ì  ì²˜ì¹˜ 5íšŒ</button>
          <button className="px-3 py-2 rounded border" onClick={()=>triggerHPBelow(0.5)}>HP 50% ì´í•˜</button>
        </div>
        {gear.skills?.length ? (
          <div className="mt-2">
            <div className="text-sm font-medium">ê³ ìœ  ìŠ¤í‚¬</div>
            <div className="flex flex-wrap gap-2 mt-1">
              {gear.skills.map((s,idx)=> (
                <button key={idx} className="px-3 py-1 rounded bg-black text-white" onClick={()=>useUniqueSkill(s)}>{s.name}ã€ˆ{s.from}ã€‰ ì‚¬ìš©</button>
              ))}
            </div>
          </div>
        ): null}
      </div>
      )}

      {/* Equipment (íˆ´íŒ ì ìš©) */}
      {devMount.equipment && (
      <div className="p-4 border rounded-2xl shadow-sm bg-white lg:col-span-2 flex flex-col gap-2">
        <div className="font-semibold">ì¥ë¹„</div>
        {/* ë¬´ê¸° */}
        <div className="text-sm font-medium mt-1">ë¬´ê¸°</div>
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
          {[
            ['ì˜¤ë¥¸ì†','weaponR'], ['ì™¼ì†','weaponL']
          ].map(([label,slot])=> {
            const it = equip[slot];
            return (
              <div key={slot} className="relative flex items-center justify-between text-sm border rounded px-2 py-1"
                   onMouseEnter={()=>setHoveredEquip(slot)} onMouseLeave={()=>setHoveredEquip(null)}>
                <div>
                  <span className="text-gray-600 inline-block w-16">{label}</span>
                  {it ? (<>
                    <b className="ml-2">{it.name}</b> <span className="text-xs text-gray-500">[{it.tier}/{typeLabel(it.type)}]</span>
                    <span className="text-xs text-gray-600 ml-2">{it.wp?`ATK ${it.wp}`:''}{it.df?` Â· DEF ${it.df}`:''}{it.block?` Â· BLK ${it.block}%`:''}</span>
                  </>) : <span className="ml-2 text-gray-400">â€” ë¯¸ì¥ì°© â€”</span>}
                </div>
                <div className="flex gap-2">{it && <button className="px-2 py-1 border rounded" onClick={()=>unequip(slot)}>í•´ì œ</button>}</div>
                {!devFast && hoveredEquip===slot && it && (
                  <div className="absolute right-2 top-full mt-1 text-[11px] px-2 py-1 bg-white border rounded shadow">{FF.ADVANCED_TOOLTIP && it.theme && (<div className="mt-1 text-[11px] text-gray-500">í…Œë§ˆ: {it.theme}</div>)}

                  </div>
                )}
              </div>
            );
          })}
        </div>
        {/* ë°©ì–´êµ¬ */}
        <div className="text-sm font-medium mt-3">ë°©ì–´êµ¬</div>
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
          {[
            ['ë¨¸ë¦¬','head'], ['ìƒì˜','chest'], ['í•˜ì˜','legs'], ['íŒ”','arms'], ['ë°œ(ì‹ ë°œ)','feet']
          ].map(([label,slot])=> {
            const it = equip[slot];
            return (
              <div key={slot} className="relative flex items-center justify-between text-sm border rounded px-2 py-1"
                   onMouseEnter={()=>setHoveredEquip(slot)} onMouseLeave={()=>setHoveredEquip(null)}>
                <div>
                  <span className="text-gray-600 inline-block w-16">{label}</span>
                  {it ? (<>
                    <b className="ml-2">{it.name}</b> <span className="text-xs text-gray-500">[{it.tier}/{typeLabel(it.type)}]</span>
                    <span className="text-xs text-gray-600 ml-2">{it.df?`DEF ${it.df}`:''}</span>
                  </>) : <span className="ml-2 text-gray-400">â€” ë¯¸ì¥ì°© â€”</span>}
                </div>
                <div className="flex gap-2">{it && <button className="px-2 py-1 border rounded" onClick={()=>unequip(slot)}>í•´ì œ</button>}</div>
                {!devFast && hoveredEquip===slot && it && (
                  <div className="absolute right-2 top-full mt-1 text-[11px] px-2 py-1 bg-white border rounded shadow">{FF.ADVANCED_TOOLTIP && it.theme && (<div className="mt-1 text-[11px] text-gray-500">í…Œë§ˆ: {it.theme}</div>)}

                  </div>
                )}
              </div>
            );
          })}
        </div>
        {/* ì¥ì‹ êµ¬ */}
        <div className="text-sm font-medium mt-3">ì¥ì‹ êµ¬</div>
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
          {[
            ['ê·€ê±¸ì´ 1','ear1'], ['ê·€ê±¸ì´ 2','ear2'], ['ëª©ê±¸ì´','necklace'], ['ë°˜ì§€ 1','ring1'], ['ë°˜ì§€ 2','ring2']
          ].map(([label,slot])=> {
            const it = equip[slot];
            return (
              <div key={slot} className="relative flex items-center justify-between text-sm border rounded px-2 py-1"
                   onMouseEnter={()=>setHoveredEquip(slot)} onMouseLeave={()=>setHoveredEquip(null)}>
                <div>
                  <span className="text-gray-600 inline-block w-16">{label}</span>
                  {it ? (<>
                    <b className="ml-2">{it.name}</b> <span className="text-xs text-gray-500">[{it.tier}/{typeLabel(it.type)}]</span>
                  </>) : <span className="ml-2 text-gray-400">â€” ë¯¸ì¥ì°© â€”</span>}
                </div>
                <div className="flex gap-2">{it && <button className="px-2 py-1 border rounded" onClick={()=>unequip(slot)}>í•´ì œ</button>}</div>
                {!devFast && hoveredEquip===slot && it && (
                  <div className="absolute right-2 top-full mt-1 text-[11px] px-2 py-1 bg-white border rounded shadow">{FF.ADVANCED_TOOLTIP && it.theme && (<div className="mt-1 text-[11px] text-gray-500">í…Œë§ˆ: {it.theme}</div>)}

                  </div>
                )}
              </div>
            );
          })}
        </div>
      </div>
      )}

      {/* Inventory + íˆ´íŒ */}
      {devMount.inventory && (
      <div className="p-4 border rounded-2xl shadow-sm bg-white flex flex-col gap-2 lg:col-span-1">
        <div className="font-semibold">ì¸ë²¤í† ë¦¬</div>
        {invList.length===0 ? (
          <div className="text-sm text-gray-500">ë³´ìœ  ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤. ìƒì ì˜ ëœë¤ ë½‘ê¸°ë‚˜ ì „íˆ¬ ë³´ìƒìœ¼ë¡œ íšë“í•´ë³´ì„¸ìš”.</div>
        ) : (
          <div className="grid grid-cols-1 gap-2">
            {invList.map(it=> (
              <div key={it.id} className="relative border rounded p-2 text-sm flex flex-col gap-1"
                   onMouseEnter={()=>setHovered(it.id)} onMouseLeave={()=>setHovered(null)}>
                <div>
                  <b>{it.name}</b> <span className="text-xs text-gray-500">[{it.tier}/{typeLabel(it.type)}]</span>
                </div>
                <div className="text-xs text-gray-600">
                  {it.wp?`ATK ${it.wp}`:''}{it.df?` Â· DEF ${it.df}`:''}{it.block?` Â· BLK ${it.block}%`:''}
                </div>
                {Object.keys(it.mod||{}).length>0 && (
                  <div className="text-xs text-green-700">{Object.entries(it.mod).map(([k,v])=>`${k}+${v}`).join(', ')}</div>
                )}
                {it.effects?.length>0 && (
                  <div className="text-[11px] text-indigo-700">íŠ¹ìˆ˜íš¨ê³¼: {it.effects.map(e=>effectToLabel(e.k,e.v)).join(' Â· ')}</div>
                )}
                {it.uniqueAbilities?.length>0 && (
                  <div className="text-[11px] text-emerald-700">ê³ ìœ  ëŠ¥ë ¥: {it.uniqueAbilities.map(a=>a.name).join(' Â· ')}</div>
                )}
                {it.uniqueSkill && (
                  <div className="text-[11px] text-rose-700">ê³ ìœ  ìŠ¤í‚¬: {it.uniqueSkill.name} [ì¿¨:{it.uniqueSkill.cooldown}]</div>
                )}
                {it.setKey && (
                  <div className="text-[11px] text-amber-700">ì„¸íŠ¸: {SET_BONUSES[it.setKey]?.name || it.setKey}</div>
                )}
                <div className="mt-1 flex gap-2">
                  {!(it.type==="material" || it.type==="consumable") && (
                    <button className="px-2 py-1 rounded bg-black text-white" onClick={()=>equipItem(it.id)}>ì¥ì°©</button>
                  )}
                  <button className="px-2 py-1 border rounded" onClick={()=>sellItem(it.id)}>íŒë§¤(+{SELL_PRICE[it.tier]||5}S)</button>
                </div>
                {!devFast && hovered===it.id && (
                  <div className="absolute right-2 top-full mt-1 text-[11px] px-2 py-1 bg-white border rounded shadow">{FF.ADVANCED_TOOLTIP && it.theme && (<div className="mt-1 text-[11px] text-gray-500">í…Œë§ˆ: {it.theme}</div>)}

                  </div>
                )}
              </div>
            ))}
          </div>
        )}
      </div>
      )}

      {/* Log */}
      {devMount.log && (
      <div className="lg:col-span-3 p-4 border rounded-2xl shadow-sm bg-white">
        <div className="font-semibold mb-2">ë¡œê·¸</div>
        <div className="space-y-1 max-h-64 overflow-auto">
          {log.slice(0,logLimit).map((e, i)=>{
            if(e.type==="xp") return <div key={i} className="text-sm">âœ¨ XP +{e.detail.amount} ({e.detail.reason})</div>
            if(e.type==="levelup") return <div key={i} className="text-sm">ğŸ†™ ë ˆë²¨ì—…! â†’ Lv.{e.detail.lvl} / í¬ì¸íŠ¸ +{e.detail.points}</div>
            if(e.type==="gacha") return <div key={i} className="text-sm">ğŸ² ê°€ì± (âˆ’{e.detail.cost}S) â†’ <b>{e.detail.tier}</b> : {e.detail.item}</div>
            if(e.type==="loot") return <div key={i} className="text-sm">ğŸ’° ì „íˆ¬({e.detail.kind}) â†’ +{e.detail.gain}S (bias {e.detail.bias})</div>
            if(e.type==="shop") return <div key={i} className="text-sm">ğŸ›’ {e.detail.buy}</div>
            if(e.type==="weekly") return <div key={i} className="text-sm">ğŸ“ˆ ì£¼ê°„ ê²°ì‚° â†’ P_base {e.detail.P_base} + LUK {e.detail.LUK_Bonus} = P{e.detail.P_total}, K={e.detail.K}{e.detail.alloc?.length?` | ë°°ë¶„: ${e.detail.alloc.map(a=>`${a.stat}+${a.delta}`).join(", ")}`:""}</div>
            if(e.type==="wave") return <div key={i} className="text-sm">ğŸŒŠ ì›¨ì´ë¸Œ({e.detail.diff}) â†’ +{e.detail.gain}S (bias {e.detail.bias})</div>
            if(e.type==="equip") return <div key={i} className="text-sm">ğŸ§° ì¥ì°©: {e.detail.slot} â†’ {e.detail.name} [{e.detail.tier}]</div>
            if(e.type==="unequip") return <div key={i} className="text-sm">ğŸ§° í•´ì œ: {e.detail.slot} ({e.detail.name})</div>
            if(e.type==="warn") return <div key={i} className="text-sm text-red-600">âš ï¸ {e.detail}</div>
            if(e.type==="proc") return <div key={i} className="text-sm">ğŸ§ª {e.detail}</div>
            if(e.type==="skill") return <div key={i} className="text-sm">ğŸ”¥ {e.detail}</div>
            return <div key={i} className="text-sm">{JSON.stringify(e)}</div>
          })}
        </div>
      </div>
      )}
    </div>
  );
}


window.Dashboard = Dashboard;

    </script>
    <script type="text/babel" data-presets="react">
        const root = ReactDOM.createRoot(document.getElementById('root'));
        (function boot(){
          if (window.Dashboard) {
            console.log('[probe] boot render');
            root.render(React.createElement(window.Dashboard));
          } else {
            setTimeout(boot, 50);
          }
        })();
    </script>
</body>
</html>
